

haproxy.cfg:
....................

global
    log /dev/log local0
    log /dev/log local1 notice
    daemon
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    option httplog
    option dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    option forwardfor
    option http-server-close

frontend https_in
    bind *:443 ssl crt /etc/haproxy/certs/nginx-selfsigned.pem
    mode http

    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Rate limiting (10 requests/sec per IP)
    stick-table type ip size 100k expire 10s store http_req_rate(10s)
    tcp-request connection track-sc0 src
    tcp-request content reject if { sc_http_req_rate(0) gt 10 }

    default_backend nodejs_cluster

frontend http_in
    bind *:80
    redirect scheme https code 301 if !{ ssl_fc }

backend nodejs_cluster
    balance leastconn
    option httpchk GET /health
    server node1 127.0.0.1:3001 check maxconn 1024
    server node2 127.0.0.1:3002 check maxconn 1024
    server node3 127.0.0.1:3003 check maxconn 1024
